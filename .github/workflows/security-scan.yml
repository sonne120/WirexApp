name: Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: |
        dotnet restore WirexApp.Domain/WirexApp.Domain.csproj
        dotnet restore WirexApp.Application/WirexApp.Application.csproj
        dotnet restore WirexApp.Infrastructure/WirexApp.Infrastructure.csproj

    - name: Run security vulnerability scan
      run: |
        echo "Scanning WirexApp.Domain..." > security-report.txt
        dotnet list WirexApp.Domain/WirexApp.Domain.csproj package --vulnerable --include-transitive 2>&1 | tee -a security-report.txt || true
        echo "Scanning WirexApp.Application..." >> security-report.txt
        dotnet list WirexApp.Application/WirexApp.Application.csproj package --vulnerable --include-transitive 2>&1 | tee -a security-report.txt || true
        echo "Scanning WirexApp.Infrastructure..." >> security-report.txt
        dotnet list WirexApp.Infrastructure/WirexApp.Infrastructure.csproj package --vulnerable --include-transitive 2>&1 | tee -a security-report.txt || true

        if grep -q "has the following vulnerable packages" security-report.txt; then
          echo "⚠️ Vulnerabilities found!"
          cat security-report.txt
        else
          echo "✅ No vulnerabilities found"
        fi

    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.txt

  docker-image-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        dockerfile:
          - path: WirexApp.Gateway/Dockerfile
            name: gateway
          - path: WirexApp.WriteService/Dockerfile
            name: write-service
          - path: WirexApp.ReadService/Dockerfile
            name: read-service

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -f ${{ matrix.dockerfile.path }} -t ${{ matrix.dockerfile.name }}:scan .

    - name: Run Trivy vulnerability scanner (table format)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ matrix.dockerfile.name }}:scan
        format: 'table'
        exit-code: '0'

    - name: Run Trivy vulnerability scanner (SARIF)
      uses: aquasecurity/trivy-action@master
      continue-on-error: true
      with:
        image-ref: ${{ matrix.dockerfile.name }}:scan
        format: 'sarif'
        output: 'trivy-results-${{ matrix.dockerfile.name }}.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v4
      if: always() && hashFiles('trivy-results-${{ matrix.dockerfile.name }}.sarif') != ''
      continue-on-error: true
      with:
        sarif_file: 'trivy-results-${{ matrix.dockerfile.name }}.sarif'

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: |
        dotnet restore WirexApp.Domain/WirexApp.Domain.csproj
        dotnet restore WirexApp.Application/WirexApp.Application.csproj
        dotnet restore WirexApp.Infrastructure/WirexApp.Infrastructure.csproj

    - name: Build solution
      run: |
        dotnet build WirexApp.Domain/WirexApp.Domain.csproj --no-restore --configuration Release
        dotnet build WirexApp.Application/WirexApp.Application.csproj --no-restore --configuration Release
        dotnet build WirexApp.Infrastructure/WirexApp.Infrastructure.csproj --no-restore --configuration Release

    - name: Run code analysis
      continue-on-error: true
      run: |
        dotnet format WirexApp.Domain/WirexApp.Domain.csproj --verify-no-changes --verbosity diagnostic || true

  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      continue-on-error: true
      with:
        path: ./
        extra_args: --only-verified

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install dotnet-project-licenses
      run: dotnet tool install --global dotnet-project-licenses

    - name: Generate license report
      continue-on-error: true
      run: |
        dotnet-project-licenses -i . -o -f markdown > licenses.md || true

    - name: Upload license report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: license-report
        path: licenses.md
        if-no-files-found: ignore

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, docker-image-scan, code-quality, secrets-scan, license-compliance]
    if: always()

    steps:
    - name: Create summary
      run: |
        echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Docker Image Scan: ${{ needs.docker-image-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Secrets Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- License Compliance: ${{ needs.license-compliance.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.dependency-scan.result }}" == "failure" ] || [ "${{ needs.docker-image-scan.result }}" == "failure" ]; then
          echo "⚠️ **Security issues detected! Please review the scan results.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ **No critical security issues found.**" >> $GITHUB_STEP_SUMMARY
        fi
