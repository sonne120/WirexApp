name: Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  workflow_dispatch:

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Run security vulnerability scan
      run: |
        dotnet list package --vulnerable --include-transitive 2>&1 | tee security-report.txt
        if grep -q "has the following vulnerable packages" security-report.txt; then
          echo "⚠️ Vulnerabilities found!"
          cat security-report.txt
          exit 1
        else
          echo "✅ No vulnerabilities found"
        fi

    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.txt

  docker-image-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        dockerfile:
          - path: WirexApp.Gateway/Dockerfile
            name: gateway
          - path: WirexApp.API/Dockerfile.WriteService
            name: write-service
          - path: WirexApp.API/Dockerfile.ReadService
            name: read-service

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -f ${{ matrix.dockerfile.path }} -t ${{ matrix.dockerfile.name }}:scan .

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ matrix.dockerfile.name }}:scan
        format: 'sarif'
        output: 'trivy-results-${{ matrix.dockerfile.name }}.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results-${{ matrix.dockerfile.name }}.sarif'

    - name: Run Trivy (table format)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ matrix.dockerfile.name }}:scan
        format: 'table'
        exit-code: '0'

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --no-restore --configuration Release

    - name: Run code analysis
      run: |
        dotnet format --verify-no-changes --verbosity diagnostic || true

  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install dotnet-project-licenses
      run: dotnet tool install --global dotnet-project-licenses

    - name: Generate license report
      run: |
        dotnet-project-licenses -i . -o -f markdown > licenses.md || true

    - name: Upload license report
      uses: actions/upload-artifact@v4
      with:
        name: license-report
        path: licenses.md

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, docker-image-scan, code-quality, secrets-scan, license-compliance]
    if: always()

    steps:
    - name: Create summary
      run: |
        echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Docker Image Scan: ${{ needs.docker-image-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Secrets Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- License Compliance: ${{ needs.license-compliance.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.dependency-scan.result }}" == "failure" ] || [ "${{ needs.docker-image-scan.result }}" == "failure" ]; then
          echo "⚠️ **Security issues detected! Please review the scan results.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ **No critical security issues found.**" >> $GITHUB_STEP_SUMMARY
        fi
